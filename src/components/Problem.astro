---
export interface Props {
    title?: string;
    description?: string;
    prefixText?: string;
    highlightText?: string;
    suffixText?: string;
}

const {
    title = "DO YOU HATE HAVING YOUR PICTURE TAKEN?",
    description = "LACK OF CONFIDENCE, FEAR OF FAILURE, AND FEELING THAT YOU AREN'T PHOTOGENIC,<br>PREVENT YOU FROM SHOWING YOUR TRUE SELF",
    prefixText = "A",
    highlightText = "PROFESSIONAL HEADSHOT",
    suffixText = "EXPERIENCE CAN CHANGE EVERYTHING"
} = Astro.props;

// Import problem section images
import { Image } from 'astro:assets';
import image0090 from '../assets/images/problem/Headshot_20250917_Sonya Lilienstein_Richard Waine_Lancaster_PA_0090 (horizontal) - compressed.jpg';
import image0056 from '../assets/images/problem/Headshot_20250917_Sonya Lilienstein_Richard Waine_Lancaster_PA_0056 (horizontal) - compressed.jpg';
import image0079 from '../assets/images/problem/Headshot_20250917_Sonya Lilienstein_Richard Waine_Lancaster_PA_0079 (horizontal) - compressed.jpg';
---

<div class="problem-wrapper">
    <div class="scroll-container" id="scroll-container-1">
        <div class="scroll-panel text-panel" id="text-panel-1">
            <div class="text-content">
                <h2 class="text-1" id="paragraph-1">{title}</h2>
                <p class="text-2" id="paragraph-2" set:html={description}></p>
                <p class="text-3 accent" id="paragraph-3">{prefixText} <span class="highlight">{highlightText}</span> {suffixText}</p>
            </div>
        </div>
        <div class="scroll-panel image-panel" id="image-panel-1">
            <div class="image-wrapper">
                <Image src={image0090} alt="Uncertain expression" id="image-1" class="panel-image" />
                <Image src={image0056} alt="Dread expression" id="image-2" class="panel-image" />
                <Image src={image0079} alt="Confident expression" id="image-3" class="panel-image" />
            </div>
        </div>
    </div>
</div>

<style is:global>
    /* Problem Wrapper - maintains full height and centers content */
    .problem-wrapper {
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    /* Scroll Container */
    .scroll-container {
        width: 100%;
        max-width: 1600px;
        height: 60vh;
        display: flex;
        gap: 0;
        margin: 0;
        padding: 0;
    }

    /* Scroll Panels */
    .scroll-panel {
        height: 60vh;
        overflow: hidden;
    }

    /* Text Panel */
    .text-panel {
        background: #121212;
        display: flex;
        align-items: center;
        justify-content: center;
        flex: 1;
    }

    .text-content {
        padding: 3rem;
        text-align: center;
        color: white;
        position: relative;
        height: 100%;
        width: 100%;
        max-width: 800px;
        margin: 0 auto;
    }

    /* All paragraphs positioned absolutely in the same spot */
    #paragraph-1,
    #paragraph-2,
    #paragraph-3 {
        position: absolute;
        top: 50%;
        left: 3rem;
        right: 3rem;
        margin: 0;
        will-change: opacity, transform;
    }

    /* Paragraph 1 - starts large and centered */
    #paragraph-1 {
        font-size: 32px;
        font-weight: 700;
        text-transform: uppercase;
        line-height: 1.3;
    }

    /* Paragraphs 2 & 3 - start hidden */
    #paragraph-2,
    #paragraph-3 {
        font-size: 20px;
        line-height: 1.7;
    }

    #paragraph-3 {
        font-weight: 700;
        font-size: 22px;
    }

    #paragraph-3 .highlight {
        color: #03a9f4;
    }

    /* Image Panels */
    .image-panel {
        flex: 0;
        overflow: hidden;
        position: relative;
    }

    .image-wrapper {
        width: 100%;
        height: 100%;
        position: relative;
    }

    .panel-image {
        width: 100%;
        height: 100%;
        object-fit: cover;
        display: block;
        position: absolute;
        top: 0;
        left: 0;
    }

    /* Responsive */
    @media (max-width: 1024px) {
        .scroll-container {
            flex-direction: column;
        }

        .text-content {
            padding: 2rem;
        }

        .text-content h2 {
            font-size: 24px;
        }

        .text-content p {
            font-size: 18px;
        }
    }
</style>

<script>
import gsap from 'gsap';
import { ScrollTrigger } from 'gsap/ScrollTrigger';

gsap.registerPlugin(ScrollTrigger);

let currentStage = 0;
let isTransitioning = false;
let isPinned = false;

document.addEventListener('DOMContentLoaded', () => {
    const problemSection = document.querySelector('#problem');
    const container = document.querySelector('#scroll-container-1');
    const textPanel = document.querySelector('#text-panel-1');
    const imagePanel = document.querySelector('#image-panel-1');
    const p1 = document.querySelector('#paragraph-1');
    const p2 = document.querySelector('#paragraph-2');
    const p3 = document.querySelector('#paragraph-3');
    const img1 = document.querySelector('#image-1');
    const img2 = document.querySelector('#image-2');
    const img3 = document.querySelector('#image-3');

    if (!p1 || !p2 || !p3 || !img1 || !img2 || !img3 || !textPanel || !imagePanel || !problemSection || !container) return;

    // Set initial states
    gsap.set(p1, { scale: 2, yPercent: -50 });
    gsap.set(p2, { opacity: 0, yPercent: -50, y: 50 });
    gsap.set(p3, { opacity: 0, yPercent: -50, y: 50 });
    gsap.set([img1, img2, img3], { opacity: 0 });

    // PIN the section using ScrollTrigger
    ScrollTrigger.create({
        trigger: problemSection,
        start: 'top top',
        end: '+=400%',
        pin: true,
        pinSpacing: true,
        scrub: false,
        onEnter: () => {
            isPinned = true;
        },
        onLeave: () => {
            isPinned = false;
        },
        onEnterBack: () => {
            isPinned = true;
        },
        onLeaveBack: () => {
            isPinned = false;
        }
    });

    // PIN the container using ScrollTrigger
    ScrollTrigger.create({
        trigger: container,
        start: 'top top',
        end: '-=400%',
        pin: true,
        pinSpacing: false,
        scrub: false,
        markers:true
    });

    function transitionToStage(targetStage: number) {
        if (targetStage === currentStage || targetStage < 0 || targetStage > 3) return;

        isTransitioning = true;
        const tl = gsap.timeline({
            onComplete: () => {
                currentStage = targetStage;
                setTimeout(() => {
                    isTransitioning = false;
                }, 300);
            }
        });

        // 0 → 1
        if (currentStage === 0 && targetStage === 1) {
            tl.to(p1, { scale: 1, duration: 0.6, ease: 'power2.out' }, 0)
              .to(textPanel, { flex: 0.5, duration: 0.6, ease: 'power2.out' }, 0)
              .to(imagePanel, { flex: 0.5, duration: 0.6, ease: 'power2.out' }, 0)
              .to(img1, { opacity: 1, duration: 0.8, ease: 'power2.inOut' }, 0);
        }
        // 1 → 0
        else if (currentStage === 1 && targetStage === 0) {
            tl.to(img1, { opacity: 0, duration: 0.3, ease: 'power2.in' }, 0)
              .to(p1, { scale: 2, duration: 0.5, ease: 'power2.in' }, 0.1)
              .to(textPanel, { flex: 1, duration: 0.5, ease: 'power2.in' }, 0.1)
              .to(imagePanel, { flex: 0, duration: 0.5, ease: 'power2.in' }, 0.1);
        }
        // 1 → 2
        else if (currentStage === 1 && targetStage === 2) {
            tl.to(p1, { opacity: 0, duration: 0.4, ease: 'power2.inOut' }, 0)
              .to(img1, { opacity: 0, duration: 0.3, ease: 'power2.inOut' }, 0)
              .to(img2, { opacity: 1, duration: 0.3, ease: 'power2.inOut' }, 0.2)
              .to(p2, { opacity: 1, y: 0, duration: 0.5, ease: 'power2.out' }, 0.2);
        }
        // 2 → 1
        else if (currentStage === 2 && targetStage === 1) {
            tl.to(p2, { opacity: 0, y: 50, duration: 0.4, ease: 'power2.in' }, 0)
              .to(img2, { opacity: 0, duration: 0.3, ease: 'power2.inOut' }, 0)
              .to(img1, { opacity: 1, duration: 0.3, ease: 'power2.inOut' }, 0.2)
              .to(p1, { opacity: 1, duration: 0.4, ease: 'power2.inOut' }, 0.2);
        }
        // 2 → 3
        else if (currentStage === 2 && targetStage === 3) {
            tl.to(p2, { opacity: 0, y: 50, duration: 0.4, ease: 'power2.in' }, 0)
              .to(img2, { opacity: 0, duration: 0.3, ease: 'power2.inOut' }, 0)
              .to(img3, { opacity: 1, duration: 0.3, ease: 'power2.inOut' }, 0.2)
              .to(p3, { opacity: 1, y: 0, duration: 0.5, ease: 'power2.out' }, 0.2);
        }
        // 3 → 2
        else if (currentStage === 3 && targetStage === 2) {
            tl.to(p3, { opacity: 0, y: 50, duration: 0.4, ease: 'power2.in' }, 0)
              .to(img3, { opacity: 0, duration: 0.3, ease: 'power2.inOut' }, 0)
              .to(img2, { opacity: 1, duration: 0.3, ease: 'power2.inOut' }, 0.2)
              .to(p2, { opacity: 1, y: 0, duration: 0.5, ease: 'power2.out' }, 0.2);
        }
    }

    let scrollAccumulator = 0;
    const scrollThreshold = 200;
    let resetTimeout: number;

    window.addEventListener('wheel', (e) => {
        // Only hijack scroll when section is PINNED
        if (!isPinned) return;

        // Block all scroll accumulation during transitions
        if (isTransitioning) {
            e.preventDefault();
            scrollAccumulator = 0;
            return;
        }

        // Only prevent default if we're in the active range
        if ((e.deltaY > 0 && currentStage < 3) || (e.deltaY < 0 && currentStage > 0)) {
            e.preventDefault();
        }

        // Add to accumulator
        scrollAccumulator += e.deltaY;

        // Reset accumulator if user stops scrolling
        clearTimeout(resetTimeout);
        resetTimeout = window.setTimeout(() => {
            scrollAccumulator = 0;
        }, 200);

        // Trigger transition once threshold is reached
        if (Math.abs(scrollAccumulator) >= scrollThreshold) {
            if (scrollAccumulator > 0 && currentStage < 3) {
                scrollAccumulator = 0;
                transitionToStage(currentStage + 1);
            } else if (scrollAccumulator < 0 && currentStage > 0) {
                scrollAccumulator = 0;
                transitionToStage(currentStage - 1);
            } else {
                scrollAccumulator = 0;
            }
        }
    }, { passive: false });
});
</script>
